(function(){var F=null,C=null,K=null,A=null,D=null,E=null;function M(){if(window.PaintWeb){G();return }var N=A.getParam("paintweb_config"),O=N.baseFolder+"paintweb.js";tinymce.ScriptLoader.load(O,G)}function G(){if(F){return }F=new PaintWeb();C=F.config;var O=A.getParam("paintweb_config"),N=document.createElement("div");D.parentNode.appendChild(N);O.imagePreload=K;O.guiPlaceholder=N;for(var P in O){C[P]=O[P]}F.init(I)}function I(N){if(N.state===PaintWeb.INIT_DONE){D.style.display="none";F.events.add("imageSave",J)}else{alert("PaintWeb initialization failed! "+N.errorMessage)}}function J(N){N.preventDefault();if(C.tinymce.imageSaveDataURI){K.src=N.dataURI}F.gui.hide();D.style.display="";K=null}function L(){if(!B(K)){K=null;return }if(F){F.imageLoad(K);F.gui.show();D.style.display="none"}else{M()}}function H(){if(K){return }A=this;D=this.getContainer();K=this.selection.getNode();L()}function B(R){var N=R.src;if(R.nodeName.toLowerCase()!=="img"||!N){return false}var Q=N.indexOf(":"),P=N.substr(0,Q+1).toLowerCase();if(P==="data:"){return true}if(P!=="http:"&&P!=="https:"){return false}var O=N.replace(/^https?:\/\//i,"");Q=O.indexOf("/");if(Q>-1){O=O.substr(0,Q)}if(O!==window.location.host){return false}return true}tinymce.PluginManager.requireLangPack("paintweb");tinymce.create("tinymce.plugins.paintweb",{init:function(N,P){N.addCommand("paintwebEdit",H);N.addButton("paintwebEdit",{title:"paintweb.editButton",cmd:"paintwebEdit",image:P+"/img/paintweb.gif"});N.onNodeChange.add(this.edNodeChange);var O=N.getParam("paintweb_config");if(O&&O.tinymce&&O.tinymce.contextmenu&&N.plugins.contextmenu){N.plugins.contextmenu.onContextMenu.add(this.pluginContextMenu)}if(O&&O.tinymce&&O.tinymce.overlayButton){N.onClick.add(this.edClick);N.onPreProcess.add(this.edPreProcess);N.onBeforeGetContent.add(this.edPreProcess);E=document.createElement("a");E.title=N.getLang("paintweb.overlayButton","Edit");E.appendChild(document.createTextNode(E.title));E.style.position="absolute";E.style.background="#fff";E.style.padding="4px 6px";E.style.border="1px solid #000";E.style.textDecoration="none";E.style.color="#000"}},edPreProcess:function(){if(E&&E.parentNode){E._targetImage=null;pNode=E.parentNode;pNode.removeChild(E)}},edNodeChange:function(O,N,R){if(!K&&E&&R===E&&E._targetImage){return }var Q=!B(R),P=null;N.setDisabled("paintwebEdit",Q);if(!E){return }if(Q){if(E.parentNode){E._targetImage=null;P=E.parentNode;P.removeChild(E)}}else{E._targetImage=R;E.style.top=(R.offsetTop+5)+"px";E.style.left=(R.offsetLeft+5)+"px";P=R.parentNode;P.appendChild(E)}},edClick:function(N,O){if(!K&&E&&O.target===E&&E._targetImage){A=N;D=N.getContainer();K=E._targetImage;L()}},pluginContextMenu:function(O,P,N){if(B(N)){P.add({title:"paintweb.contextMenuEdit",cmd:"paintwebEdit"})}},createControl:function(O,N){return null},getInfo:function(){return{longname:"PaintWeb - online painting application",author:"Mihai Åžucan",authorurl:"http://www.robodesign.ro/mihai",infourl:"http://code.google.com/p/paintweb",version:"0.9"}}});tinymce.PluginManager.add("paintweb",tinymce.plugins.paintweb)})();